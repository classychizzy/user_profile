name: CICD

on:
  push:
    branches: [ main ]

jobs:
  build:
  runs-on: ubuntu-latest
  steps:
    - name: checkout
      uses: actions/checkout@v2
    - name: build image
      run: docker build -t $userprofile/nodejs.app:latest .
    - name: login to docker hub
      run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
    - name: push image to docker hub
      run: docker push $userprofile/nodejs.app:latest

deploy:
  needs: build
  #name of the job/runner in repo
  runs-on: [aws-ec2]
  steps:
    - name: pull image from docker hub
      run: docker pull $userprofile/nodejs.app:latest
    - name: delete old container
      run: docker rm -f nodejs.app-container
    - name: run new container
      run: docker run -d --name nodejs.app-container -p 3000:3000 $userprofile/nodejs.app:latest
